<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin Panel</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
</head>
<body>
  <h1>Perjury Admin</h1>
  <p>Client IP: {{ ip }}</p>

  <div class="section">
    <h2>Settings</h2>
    <form method="post" action="{{ url_for('admin.admin_index') }}?key={{ settings.ADMIN_KEY }}">
      <label>PIN
        <input type="password" name="PIN" value="{{ settings.PIN }}">
      </label>
      <label>DEBUG_KEY
        <input type="text" name="DEBUG_KEY" value="{{ settings.DEBUG_KEY }}">
      </label>
      <label>SHUTDOWN_KEY
        <input type="text" name="SHUTDOWN_KEY" value="{{ settings.SHUTDOWN_KEY }}">
      </label>
      <label>ADMIN_KEY
        <input type="text" name="ADMIN_KEY" value="{{ settings.ADMIN_KEY }}">
      </label>
      <label>DISPLAY_MS (ms)
        <input type="number" name="DISPLAY_MS" value="{{ settings.DISPLAY_MS }}">
      </label>
      <label>TOKEN_TTL (sec)
        <input type="number" name="TOKEN_TTL" value="{{ settings.TOKEN_TTL }}">
      </label>
      <label>TEMP_BLOCK_SECONDS (sec)
        <input type="number" name="TEMP_BLOCK_SECONDS" value="{{ settings.TEMP_BLOCK_SECONDS }}">
      </label>
      <label>LOCK_MODE
        <select name="LOCK_MODE">
          <option value="single_ip" {% if settings.LOCK_MODE == 'single_ip' %}selected{% endif %}>single_ip</option>
          <option value="all_ip" {% if settings.LOCK_MODE == 'all_ip' %}selected{% endif %}>all_ip</option>
        </select>
      </label>
      <p>Global block until: <span class="code">{{ global_until }}</span></p>
      <button type="submit">Save Settings</button>
      <a href="{{ url_for('admin.admin_clear_log') }}?key={{ settings.ADMIN_KEY }}">Clear Log</a>
      <a href="{{ url_for('admin.admin_clear_global_route') }}?key={{ settings.ADMIN_KEY }}">Clear Global Block</a>
    </form>
  </div>

  <div class="section">
    <h2>Blocked IPs</h2>
    {% if blocked %}
      <table>
        <tr><th>IP</th><th>Permanent</th><th>First Seen</th><th>Actions</th></tr>
        {% for b in blocked %}
          <tr>
            <td class="code">{{ b.ip }}</td>
            <td>{{ 'yes' if b.permanent else 'no' }}</td>
            <td>
              {% if b.first_seen %}
                {{ b.first_seen|timestamp }}
              {% else %}
                -
              {% endif %}
            </td>
            <td>
              <a href="{{ url_for('admin.admin_delete_block') }}?key={{ settings.ADMIN_KEY }}&ip={{ b.ip }}">Delete</a>
            </td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>No blocked IPs.</p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Recent Log (latest 100)</h2>
    {% if logs %}
      <table>
        <tr><th>Time</th><th>Event</th><th>IP</th><th>Extra</th></tr>
        {% for e in logs %}
          <tr>
            <td class="code">{{ e.ts }}</td>
            <td class="code">{{ e.event }}</td>
            <td class="code">{{ e.ip }}</td>
            <td class="code">{{ e.extra }}</td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>No log entries.</p>
    {% endif %}
  </div>
</body>
</html>
